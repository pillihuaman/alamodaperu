import{a as j}from"./chunk-4U6BYZNV.js";import{a as U}from"./chunk-DEYWHEGI.js";import{a as u}from"./chunk-TVVRTYFL.js";import{I as f,Kb as y,L as s,_d as I,aa as h,m as g,p as a,r as c,vb as S,wb as b,y as l,yb as v}from"./chunk-V3AJZABF.js";function p(i){return i.map(o=>{let e=[];o.children?.length&&o.children.forEach(t=>{let n=t.children?.length?p(t.children):void 0;e.push({title:t.title,icon:t.icon??"file-text-outline",link:t.link,children:n})});let r=o.link?o.link:`/support/${o.title.toLowerCase()}`;return{title:o.title,icon:o.icon??"folder-outline",link:r,expanded:o.expanded??!0,children:e.length>0?e:void 0}})}var k=class i extends U{constructor(e,r,t,n,T){super();this.http=e;this.router=r;this.toastrService=t;this.systemService=n;this.platformId=T;this.isBrowser=S(this.platformId);let m=null;if(this.isBrowser){let d=localStorage.getItem("usuario");m=d?JSON.parse(d):null}this.currentUserSubject=new g(m),this.currentUser=this.currentUserSubject.asObservable()}currentUserSubject;currentUser;isBrowser;menuTree=[];isMenuLoaded=!1;get getCurrentUserValue(){if(!this.currentUserSubject.value&&this.isBrowser){let e=localStorage.getItem("usuario");if(e){let r=JSON.parse(e);return this.currentUserSubject.next(r),r}}return this.currentUserSubject.value}login(e,r){return this.verifyCredentials(e,r).pipe(c(t=>{let n=t.payload.user;return n.access_token=t.payload.accessToken,this.currentUserSubject.next(n),this.isBrowser&&(localStorage.setItem("token",t.payload.accessToken),this.loadSystemsMenu()),n}),l(t=>(this.toastrService.danger("Login failed","Authentication Error"),a(()=>new Error("Login failed")))))}loadSystemsMenu(){this.systemService.findSystemMenuTree().subscribe({next:e=>{this.menuTree=p(e.payload),this.isMenuLoaded=!0,console.log("\u2705 Men\xFA cargado:",this.menuTree)},error:e=>{console.error("\u274C Error al cargar el men\xFA:",e)}})}logout(){this.isBrowser&&(localStorage.removeItem("usuario"),localStorage.removeItem("token"),localStorage.clear()),this.currentUserSubject.next(null)}verifyCredentials(e,r){this.isBrowser&&localStorage.clear();let t=new b({Accept:"application/json","Content-Type":"application/json",email:e,password:r}),n=`${u.API_SEGURIDAD}/api/v1/auth/authenticate`;return this.http.post(n,{email:e,password:r},{headers:t})}clearUser(){this.isBrowser&&localStorage.clear(),this.currentUserSubject.next(null)}getGuestToken(){let e=`${u.API_SEGURIDAD}/api/v1/auth/guest`;return this.http.post(e,{}).pipe(c(r=>{let t=r?.payload?.accessToken??r?.accessToken??null;return t&&this.isBrowser&&localStorage.setItem("token",t),t}),l(r=>(this.toastrService.danger("Error al obtener token guest","Token"),a(()=>new Error("No se pudo generar token guest")))))}static \u0275fac=function(r){return new(r||i)(s(v),s(y),s(I),s(j),s(h))};static \u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})};export{k as a};
