import{a as M,b as le}from"./chunk-TVVRTYFL.js";import{Da as c,Ea as s,Fa as u,Gb as Q,I,Ia as f,Ka as b,Kb as W,L as v,La as p,Md as se,Nd as ce,Ob as Y,Od as pe,Pa as A,Qa as O,Qb as G,Qd as me,R as m,Ra as P,S as l,Ta as y,Ub as J,Va as N,Xa as B,Y as S,Ya as R,Za as H,bb as L,cb as V,db as z,ea as x,fb as F,ha as r,ic as K,kd as X,la as h,ld as Z,md as ee,nb as j,nd as te,oa as E,ob as D,od as ie,pb as $,pd as ne,qd as oe,r as w,ra as T,rd as re,sd as ae,ta as d,ub as q,wa as a,ya as k,yb as U}from"./chunk-V3AJZABF.js";var _=class i{constructor(t){this.sanitizer=t}transform(t){return this.sanitizer.bypassSecurityTrustHtml(t)}static \u0275fac=function(e){return new(e||i)(h(Q,16))};static \u0275pipe=T({name:"safeHtml",type:i,pure:!0})};var C=class i{constructor(t,e){this.http=t;this.apiService=e}sendMessage(t){let e=`${M.API_INTELLIGENCY_ARTIFICIAL}/${M.URL_TYPE_ACCES_PRIVATE}/v1/ia/iaService/deepseek-chat`,n=t;return this.apiService.post(e,n).pipe(w(o=>!o||!o.payload?(console.error("Respuesta inv\xE1lida o sin payload desde el backend del chatbot."),{reply:"Lo siento, no pude obtener una respuesta del servidor.",actions:[]}):o.payload))}static \u0275fac=function(e){return new(e||i)(v(U),v(le))};static \u0275prov=I({token:i,factory:i.\u0275fac,providedIn:"root"})};var he=["messageContainer"],be=(i,t)=>({"user-message":i,"bot-message":t});function fe(i,t){i&1&&(c(0,"div",18),u(1,"nb-spinner",19),s())}function _e(i,t){if(i&1&&(u(0,"div",20),V(1,"safeHtml")),i&2){let e=p().$implicit;a("innerHTML",z(1,1,e.text),x)}}function Ce(i,t){if(i&1){let e=f();c(0,"button",23),b("click",function(){let o=m(e).$implicit,g=p(4);return l(g.handleActionClick(o))}),y(1),s()}if(i&2){let e=t.$implicit;r(),N(" ",e.label," ")}}function ve(i,t){if(i&1&&(c(0,"div",21),d(1,Ce,2,1,"button",22),s()),i&2){let e=p().$implicit;r(),a("ngForOf",e.actions)}}function xe(i,t){if(i&1&&(c(0,"div",13)(1,"div",14),d(2,fe,2,0,"div",15)(3,_e,2,3,"div",16)(4,ve,2,1,"div",17),s()()),i&2){let e=t.$implicit;r(),a("ngClass",L(4,be,e.author==="user",e.author==="bot")),r(),a("ngIf",e.isLoading),r(),a("ngIf",!e.isLoading),r(),a("ngIf",e.actions&&e.actions.length>0)}}function ye(i,t){if(i&1){let e=f();c(0,"nb-card",6)(1,"nb-card-header"),y(2," Asistente Virtual "),s(),c(3,"nb-card-body",7,1),d(5,xe,5,7,"div",8),s(),c(6,"nb-card-footer")(7,"div",9)(8,"input",10),H("ngModelChange",function(o){m(e);let g=p();return R(g.userInput,o)||(g.userInput=o),l(o)}),b("keyup.enter",function(){m(e);let o=p();return l(o.sendMessage())}),s(),c(9,"button",11),b("click",function(){m(e);let o=p();return l(o.sendMessage())}),u(10,"nb-icon",12),s()()()()}if(i&2){let e=p();r(5),a("ngForOf",e.messages),r(3),B("ngModel",e.userInput),r(),a("disabled",!e.userInput.trim())}}function Me(i,t){if(i&1&&u(0,"div",20),i&2){let e=t.$implicit;a("innerHTML",e,x)}}var ue=class i{constructor(t,e){this.chatbotService=t;this.router=e}context="general";initialMessage="\xA1Hola! Soy tu asistente virtual. \xBFEn qu\xE9 puedo ayudarte hoy?";onActionExecute=new S;messageContainer;messages=[];userInput="";isMinimized=!0;ngOnInit(){this.addBotMessage(this.initialMessage)}ngAfterViewChecked(){this.scrollToBottom()}toggleChat(){this.isMinimized=!this.isMinimized}sendMessage(){let t=this.userInput.trim();if(!t)return;this.addUserMessage(t),this.userInput="",this.addBotMessage("",!0);let e={message:t,context:this.context,conversationHistory:this.messages.filter(n=>!n.isLoading).map(n=>({author:n.author,text:n.text}))};this.chatbotService.sendMessage(e).subscribe({next:n=>{this.updateLastBotMessage(n.reply,n.actions||[])},error:n=>{console.error("Error al comunicarse con el chatbot:",n),this.updateLastBotMessage("Lo siento, estoy teniendo problemas para conectarme. Int\xE9ntalo de nuevo m\xE1s tarde.")}})}handleActionClick(t){switch(this.addUserMessage(`He seleccionado: "${t.label}"`),t.type){case"ROUTE":this.router.navigate([t.value]),this.addBotMessage(`Ok, te estoy llevando a ${t.label}.`);break;case"API_CALL":case"FUNCTION":this.onActionExecute.emit(t),this.userInput=`Quiero ejecutar la acci\xF3n: ${t.label}`,this.sendMessage();break}}addUserMessage(t){this.messages.push({text:t,author:"user",timestamp:new Date})}addBotMessage(t,e=!1){this.messages.push({text:t,author:"bot",timestamp:new Date,isLoading:e})}updateLastBotMessage(t,e=[]){let n=this.messages[this.messages.length-1];n&&n.author==="bot"&&n.isLoading?(n.text=t,n.isLoading=!1,n.actions=e):this.addBotMessage(t)}scrollToBottom(){try{this.messageContainer.nativeElement.scrollTop=this.messageContainer.nativeElement.scrollHeight}catch{}}static \u0275fac=function(e){return new(e||i)(h(C),h(W))};static \u0275cmp=E({type:i,selectors:[["app-chatbot"]],viewQuery:function(e,n){if(e&1&&A(he,5),e&2){let o;O(o=P())&&(n.messageContainer=o.first)}},inputs:{context:"context",initialMessage:"initialMessage"},outputs:{onActionExecute:"onActionExecute"},decls:6,vars:4,consts:[["safeHtml",""],["messageContainer",""],[1,"chatbot-container"],["nbButton","","status","primary","shape","round",1,"chat-toggle-button",3,"click"],[3,"icon"],["class","chat-window",4,"ngIf"],[1,"chat-window"],[1,"message-container"],["class","message-wrapper",4,"ngFor","ngForOf"],[1,"input-area"],["nbInput","","fullWidth","","placeholder","Escribe tu mensaje...",3,"ngModelChange","keyup.enter","ngModel"],["nbButton","","status","primary",3,"click","disabled"],["icon","paper-plane-outline"],[1,"message-wrapper"],[1,"message",3,"ngClass"],["class","typing-indicator",4,"ngIf"],[3,"innerHTML",4,"ngIf"],["class","action-buttons",4,"ngIf"],[1,"typing-indicator"],["size","tiny"],[3,"innerHTML"],[1,"action-buttons"],["nbButton","","outline","","size","tiny","status","primary",3,"click",4,"ngFor","ngForOf"],["nbButton","","outline","","size","tiny","status","primary",3,"click"]],template:function(e,n){if(e&1){let o=f();c(0,"div",2)(1,"button",3),b("click",function(){return m(o),l(n.toggleChat())}),u(2,"nb-icon",4),s(),d(3,ye,11,3,"nb-card",5),s(),d(4,Me,1,1,"ng-template",null,0,F)}e&2&&(k("minimized",n.isMinimized),r(2),a("icon",n.isMinimized?"message-circle-outline":"close-outline"),r(),a("ngIf",!n.isMinimized))},dependencies:[q,j,D,$,K,Y,G,J,oe,ne,te,ie,ee,Z,X,ce,se,ae,re,me,pe,_],styles:["[_nghost-%COMP%]{position:fixed;bottom:20px;right:20px;z-index:1000}.chat-toggle-button[_ngcontent-%COMP%]{width:60px;height:60px;box-shadow:0 4px 12px #0003}.chat-window[_ngcontent-%COMP%]{width:370px;height:500px;display:flex;flex-direction:column;position:absolute;bottom:80px;right:0;box-shadow:0 5px 20px #00000040;border-radius:var(--card-border-radius);overflow:hidden}.message-container[_ngcontent-%COMP%]{flex-grow:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:1rem}.message-wrapper[_ngcontent-%COMP%]{display:flex}.message[_ngcontent-%COMP%]{padding:.75rem 1rem;border-radius:18px;max-width:80%;line-height:1.4}.bot-message[_ngcontent-%COMP%]{background-color:var(--background-basic-color-2);border-bottom-left-radius:4px;align-self:flex-start}.user-message[_ngcontent-%COMP%]{background-color:var(--color-primary-500);color:var(--text-control-color);border-bottom-right-radius:4px;margin-left:auto}.typing-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;padding:.5rem}.input-area[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}.action-buttons[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}@media (max-width: 480px){[_nghost-%COMP%]{bottom:10px;right:10px}.chat-window[_ngcontent-%COMP%]{width:calc(100vw - 20px);height:calc(100vh - 90px);bottom:70px}}"]})};export{ue as a};
